syntax = "proto3";
package ploioproto;

service PloioAPI {
  rpc ListApplications (ApplicationGet) returns (ApplicationList) {}
  rpc GetApplication (ApplicationGet) returns (Application) {}
  rpc CreateApplication (ApplicationCreate) returns (Application) {}
  rpc ListClusters (ClusterGet) returns (ClusterList) {}
  rpc ListPipelines (PipelineGet) returns (PipelineList) {}
  rpc CreatePipeline (PipelineCreate) returns (Pipeline) {}
  rpc CreateStage (Stage) returns (Stage) {}
  rpc ListStage (StageGet) returns (StageList) {}
}



message ApplicationCreate {
    string Name = 1;
    string Owner = 2;
    string Repo = 3;
    // Optional values below
    repeated Env Env = 6;
    repeated Service Services = 7;
}

message ApplicationGet {
    int32 ID = 1;
    string Name = 2;
}

message ApplicationList {
    repeated Application Applications = 1;
}


message Application {
    int32 ID = 1;
    string Name = 2;
    string Owner = 3;
    string Repo = 4;

    repeated Pipeline Pipelines = 5;
    repeated Env Env = 6;
    repeated Service Services = 7;
}

message Pipeline {
    int32 ID = 1;
    string Name = 2;
    int32 Order = 3;
    repeated Stage Stages = 4;
}

message PipelineGet {
    string Application = 1;
    string Name = 2;
}

message PipelineList {
    repeated Pipeline Pipelines = 1;
}

message PipelineCreate {
    string Application = 1;
    string Name = 2;

    //optional
    repeated Stage Stages = 3;
}

message Stage {
    int32 ID = 1;
    string Name = 2;
    StageType Type = 3;
    int32 Order = 4;
    string Strategy = 5;
    Cluster Cluster = 6;
    string Namespace = 7;
    string Memory = 8;
    string Proc = 9;
    int32 Replicas = 10;
    int32 MaxUnavailable = 11;
    int32 MaxSurge = 12;
    bool NotifyEmail = 13;
    bool NotifySlack = 14;
    string SmokeHeaderKey = 15;
    string SmokeHeaderVal = 16;
    int32 CanaryPercentage = 17;
    int64 WaitDuration = 18;
}

message StageGet {
    string Pipeline = 1;
    string Name = 2;
}

message StageList {
    repeated Stage Stages = 1;
}

enum StageType {
   Deploy = 0; 
   Check = 1;
   Teardown = 2;
   Wait = 3;
}

message Env {
    int32 ID = 1;
    string Name = 2;
    string Key = 4;
    string Value = 5;
    string ConfigMap = 6;
    string Secret = 7;
}

message Cluster {
    int32 ID = 1;
    string Name = 2;
    string URL = 3;
}

message ClusterGet {
    string Name = 1;
}

message ClusterList {
    repeated Cluster Clusters = 1;
}

message ClusterCreate {
    string Name = 1;
    string URL = 2;
}

message Service {
    int32 ID = 1;
    string Name = 2;
    string Application = 3;
    ServiceType Type = 4;
    repeated Port Ports = 5;
}

enum ServiceType {
    ClusterIP = 0;
    NodePort = 1;
    LoadBalancer = 2;
    ExternalName = 3;
}

message Port {
    string Name = 1;
    string Protocol = 2;
    string Port = 3;
    string TargetPort = 4;
    string NodePort = 5;
}

